name: Lint Rust sources
on:
  pull_request:
    paths:
    - 'src/rust/**'
  
jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - 
        uses: actions/checkout@v3
      -
        name: Get changed files
        id: files
        uses: jitterbit/get-changed-files@v1
        with:
          format: json
      -
        name: Cache rust stuff
        uses: actions/cache@v3
        with:
          path: |
            ~/.cargo/registry/index
            ~/.cargo/registry/cache
            ~/.cargo/git/db
            ~/.cargo/bin
            src/rust/**/target
          key: ${{ runner.os }}-cargo3-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: ${{ runner.os }}-cargo3-
      -
        uses: actions-rs/toolchain@v1
        with:
          toolchain: nightly
          override: true
          components: clippy
          target: wasm32-unknown-unknown
      -
        name: Other dependencies
        run: sudo apt-get install -y moreutils
      -
        name: Lint sources
        id: lint
        run: |
          readarray -t TEMP <<< "$(jq -r '.[]' <<<'${{ steps.files.outputs.added_modified }}')"

          let LINT_COUNT=0
          while IFS= read -r -d $'\0' i; do
            if [[ "$i" == *"src/rust"* ]]; then
              (
                cd "$i"
                cargo clippy --message-format=json > annotations.json
                jq --raw-output \
                   --slurp \
                   --arg WORKING_DIRECTORY "${i%/}" \
                   --from-file ${{ github.workspace }}/.github/workflows/supporting/annotations.jq 
                   annotations.json
                let "LINT_COUNT = $LINT_COUNT + $(jq -sr 'map(select(.reason == "compiler-message" and .message.code and .message.spans[].is_primary)) | length' annotations.json)"
              )
            fi
          done < <(printf "%s\n" "${TEMP[@]}" | cut -d'/' -f-3 | sort -u | grep 'src' | tr '\n' '\0')

          if ! [ $LINT_COUNT = '0' ]; then
            exit 1
          fi
